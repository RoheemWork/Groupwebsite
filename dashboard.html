<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - DripCase</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Navbar -->
  <header class="navbar">
    <div class="left">
      <a href="index.html" class="back-to-home-link">‚Üê Back to Home</a>
    </div>
    <div class="center">
      <a href="index.html"><img src="assets/logo.png" alt="DripCase Logo" class="logo" /></a>
    </div>
    <div class="right"></div>
  </header>

  <main class="dashboard-main">
    <div class="dashboard-container">
      <h1>Admin Dashboard</h1>
      
      <!-- User Frequency Analysis Section -->
      <section class="frequency-analysis">
        <h2>User Frequency Analysis</h2>
        <button class="submit-btn" onclick="ShowUserFrequency()">Generate Frequency Charts</button>
        
        <div class="charts-container">
          <div class="chart-box">
            <h3>Gender Distribution</h3>
            <div id="genderChartContainer"></div>
          </div>
          <div class="chart-box">
            <h3>Age Group Distribution</h3>
            <div id="ageChartContainer"></div>
          </div>
        </div>
      </section>

      <hr>

      <!-- Invoice Management Section -->
      <section class="invoice-management">
        <h2>Invoice Management</h2>
        
        <!-- Show All Invoices (with search) -->
        <div class="invoice-tool">
          <h3>Search All Invoices by TRN</h3>
          <div class="search-form">
            <input type="text" id="searchAllTrn" placeholder="Enter TRN (e.g., 123-456-789)">
            <button class="submit-btn" onclick="ShowInvoices()">Search Invoices</button>
          </div>
          <div id="allInvoicesContainer"></div>
        </div>

        <!-- Get User Invoices -->
        <div class="invoice-tool">
          <h3>Get Invoices for a Specific User</h3>
          <div class="search-form">
            <input type="text" id="searchUserTrn" placeholder="Enter User TRN (e.g., 123-456-789)">
            <button class="submit-btn" onclick="GetUserInvoices()">Get User Invoices</button>
          </div>
          <div id="userInvoicesContainer"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-bottom">
      <p>&copy; 2023 DripCase. All rights reserved.</p>
    </div>
  </footer>

  <!-- =================================================================== -->
  <!-- JAVASCRIPT FOR dashboard.html -->
  <!-- =================================================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {

      // --- UTILITY FUNCTIONS ---
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 5px;
          color: white; z-index: 10000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          background-color: ${type === 'success' ? '#4CAF50' : '#F44336'};
          animation: slideInRight 0.5s, fadeOut 0.5s 2.5s forwards;
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      // --- PROFILE & AUTHENTICATION ---
      function checkLoginStatus() {
        const currentUserTrn = sessionStorage.getItem('currentUserTrn');
        if (currentUserTrn) {
          const registrationData = JSON.parse(localStorage.getItem('RegistrationData')) || [];
          const userData = registrationData.find(user => user.trn === currentUserTrn);
          if (userData) {
            return userData;
          }
        }
        return null;
      }

      // --- DASHBOARD PAGE LOGIC ---
      const currentUser = checkLoginStatus();

      if (!currentUser || !currentUser.isAdmin) {
        showNotification('You do not have permission to view this page.', 'error');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }
      
      const BAR_COLORS = {
        male: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==',
        female: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
        other: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
        age: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8//8/AwMDAwMDAwMDAAAAAL2NDP7H7Y5oAAAAASUVORK5CYII='
      };

      function calculateAge(birthday) {
        const ageDifMs = Date.now() - birthday.getTime();
        const ageDate = new Date(ageDifMs);
        return Math.abs(ageDate.getUTCFullYear() - 1970);
      }

      // Attach functions to the global window object so they can be called from HTML onclick
      window.ShowUserFrequency = function() {
        const registrationData = JSON.parse(localStorage.getItem('RegistrationData')) || [];
        const genderCounts = { Male: 0, Female: 0, Other: 0 };
        const ageCounts = { '18-25': 0, '26-35': 0, '36-50': 0, '50+': 0 };

        registrationData.forEach(user => {
          if (user.gender) genderCounts[user.gender] = (genderCounts[user.gender] || 0) + 1;
          if (user.dob) {
            const age = calculateAge(new Date(user.dob));
            if (age >= 18 && age <= 25) ageCounts['18-25']++;
            else if (age >= 26 && age <= 35) ageCounts['26-35']++;
            else if (age >= 36 && age <= 50) ageCounts['36-50']++;
            else if (age > 50) ageCounts['50+']++;
          }
        });

        const genderChartHTML = `
          <ul class="bar-chart">${Object.entries(genderCounts).map(([gender, count]) => `
            <li><span class="label">${gender}:</span><div class="bar-container"><img src="${BAR_COLORS[gender.toLowerCase()]}" class="bar" style="width: ${count * 20}px;" alt="${gender} bar"></div><span class="count">${count}</span></li>`).join('')}
          </ul>`;
        document.getElementById('genderChartContainer').innerHTML = genderChartHTML;

        const ageChartHTML = `
          <ul class="bar-chart">${Object.entries(ageCounts).map(([group, count]) => `
            <li><span class="label">${group}:</span><div class="bar-container"><img src="${BAR_COLORS.age}" class="bar" style="width: ${count * 20}px;" alt="${group} bar"></div><span class="count">${count}</span></li>`).join('')}
          </ul>`;
        document.getElementById('ageChartContainer').innerHTML = ageChartHTML;
      };

      window.ShowInvoices = function() {
        const searchTrn = document.getElementById('searchAllTrn').value.trim();
        const allInvoices = JSON.parse(localStorage.getItem('AllInvoices')) || [];
        const container = document.getElementById('allInvoicesContainer');
        if (!searchTrn) { container.innerHTML = '<p class="error-message">Please enter a TRN to search.</p>'; return; }
        const filteredInvoices = allInvoices.filter(inv => inv.trn === searchTrn);
        if (filteredInvoices.length === 0) { container.innerHTML = `<p>No invoices found for TRN: ${searchTrn}</p>`; return; }
        let tableHTML = `<table><thead><tr><th>Invoice #</th><th>Date</th><th>Name</th><th>Total</th></tr></thead><tbody>`;
        filteredInvoices.forEach(inv => {
          tableHTML += `<tr><td>${inv.invoiceNumber}</td><td>${inv.date}</td><td>${inv.shippingInfo.fullName}</td><td>$${inv.total.toFixed(2)}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      };

      window.GetUserInvoices = function() {
        const searchTrn = document.getElementById('searchUserTrn').value.trim();
        const registrationData = JSON.parse(localStorage.getItem('RegistrationData')) || [];
        const container = document.getElementById('userInvoicesContainer');
        if (!searchTrn) { container.innerHTML = '<p class="error-message">Please enter a TRN to search.</p>'; return; }
        const user = registrationData.find(u => u.trn === searchTrn);
        if (!user) { container.innerHTML = `<p>No user found with TRN: ${searchTrn}</p>`; return; }
        const userInvoices = user.invoices || [];
        if (userInvoices.length === 0) { container.innerHTML = `<p>User ${user.name} has no past invoices.</p>`; return; }
        let tableHTML = `<h4>Invoices for ${user.name} (${searchTrn})</h4><table><thead><tr><th>Invoice #</th><th>Date</th><th>Total</th></tr></thead><tbody>`;
        userInvoices.forEach(inv => {
          tableHTML += `<tr><td>${inv.invoiceNumber}</td><td>${inv.date}</td><td>$${inv.total.toFixed(2)}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      };
    });
  </script>
</body>
</html>