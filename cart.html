<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Cart - DripCase</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Navbar -->
  <header class="navbar">
    <div class="left">
      <a href="index.html" class="back-to-home-link">‚Üê Continue Shopping</a>
    </div>
    <div class="center">
      <a href="index.html"><img src="assets/logo.png" alt="DripCase Logo" class="logo" /></a>
    </div>
    <div class="right"></div>
  </header>

  <main class="cart-main">
    <div class="checkout-container">
      <h1>Your Shopping Cart</h1>
      
      <div class="checkout-grid">
        <!-- Order Summary -->
        <section class="order-summary">
          <h2>Order Summary</h2>
          <table id="cartTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="summary-totals">
            <p>Subtotal: <span id="cartSubtotal">$0.00</span></p>
            <p>Tax (15%): <span id="cartTax">$0.00</span></p>
            <p class="total-cost">Total: <span id="cartTotal">$0.00</span></p>
          </div>
        </section>

        <!-- Shipping Details -->
        <section class="shipping-details">
          <h2>Shipping Information</h2>
          <form id="shippingForm">
            <input type="text" id="fullName" placeholder="Full Name" required>
            <textarea id="address" placeholder="Full Address" rows="4" required></textarea>
            <input type="text" id="trn" placeholder="TRN" readonly>
            
            <div class="form-actions">
              <button type="button" id="cancelCheckoutBtn" class="cancel-btn">Cancel</button>
              <button type="submit" class="submit-btn">Confirm Order</button>
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-bottom">
      <p>&copy; 2023 DripCase. All rights reserved.</p>
    </div>
  </footer>

  <!-- =================================================================== -->
  <!-- JAVASCRIPT FOR cart.html -->
  <!-- =================================================================== -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {

      const TAX_RATE = 0.15;
      const cartTableBody = document.querySelector("#cartTable tbody");
      const cartSubtotalEl = document.getElementById('cartSubtotal');
      const cartTaxEl = document.getElementById('cartTax');
      const cartTotalEl = document.getElementById("cartTotal");
      const shippingForm = document.getElementById('shippingForm');
      const fullNameInput = document.getElementById('fullName');
      const trnInput = document.getElementById('trn');

      // --- UTILITY FUNCTIONS ---
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 5px;
          color: white; z-index: 10000; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          background-color: ${type === 'success' ? '#4CAF50' : '#F44336'};
          animation: slideInRight 0.5s, fadeOut 0.5s 2.5s forwards;
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      // --- PROFILE & AUTHENTICATION ---
      function checkLoginStatus() {
        const currentUserTrn = sessionStorage.getItem('currentUserTrn');
        if (currentUserTrn) {
          const registrationData = JSON.parse(localStorage.getItem('RegistrationData')) || [];
          const userData = registrationData.find(user => user.trn === currentUserTrn);
          if (userData) {
            return userData;
          }
        }
        return null;
      }

      // --- CART FUNCTIONALITY ---
      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("dripcaseCart")) || [];
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        // This function is not strictly needed on the cart page itself, but good for consistency if a navbar is present.
      }

      // --- INVOICE GENERATION ---
      function generateInvoice(shippingInfo) {
        const cart = JSON.parse(localStorage.getItem("dripcaseCart")) || [];
        if (cart.length === 0) {
          showNotification("Your cart is empty.", 'error');
          return;
        }

        let subtotal = 0;
        const itemsWithTotal = cart.map(item => {
          const total = item.price * item.quantity;
          subtotal += total;
          return { ...item, total };
        });

        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;

        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter') || '1');
        const invoiceNumber = `INV-${String(invoiceCounter).padStart(5, '0')}`;
        localStorage.setItem('invoiceCounter', invoiceCounter + 1);

        const invoice = {
          invoiceNumber,
          date: new Date().toLocaleDateString(),
          company: "DripCase",
          shippingInfo,
          trn: shippingInfo.trn,
          items: itemsWithTotal,
          subtotal,
          tax,
          total
        };

        let allInvoices = JSON.parse(localStorage.getItem('AllInvoices')) || [];
        allInvoices.push(invoice);
        localStorage.setItem('AllInvoices', JSON.stringify(allInvoices));

        let registrationData = JSON.parse(localStorage.getItem('RegistrationData')) || [];
        const userIndex = registrationData.findIndex(u => u.trn === shippingInfo.trn);
        if (userIndex !== -1) {
          if (!registrationData[userIndex].invoices) {
            registrationData[userIndex].invoices = [];
          }
          registrationData[userIndex].invoices.push(invoice);
          localStorage.setItem('RegistrationData', JSON.stringify(registrationData));
        }

        localStorage.removeItem("dripcaseCart");
        updateCartCount();
        sessionStorage.setItem('currentInvoice', JSON.stringify(invoice));
        
        showNotification("Order confirmed! Generating invoice...");
        setTimeout(() => window.location.href = 'invoice.html', 1500);
      }

      // --- CART PAGE LOGIC ---
      if (!cartTableBody || !cartSubtotalEl || !cartTaxEl || !cartTotalEl || !shippingForm || !fullNameInput || !trnInput) {
        console.error("Cart page is missing critical HTML elements. Script cannot run.");
        showNotification("A critical error occurred. The page may not have loaded correctly.", 'error');
        return;
      }

      const currentUser = checkLoginStatus();
      if (!currentUser) {
        showNotification('You must be logged in to proceed to checkout.', 'error');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }

      fullNameInput.value = currentUser.name || '';
      trnInput.value = currentUser.trn || '';

      function renderCartSummary() {
        const cart = JSON.parse(localStorage.getItem("dripcaseCart")) || [];
        cartTableBody.innerHTML = "";
        
        if (cart.length === 0) {
          cartTableBody.innerHTML = '<tr><td colspan="5">Your cart is empty.</td></tr>';
          cartSubtotalEl.textContent = '$0.00';
          cartTaxEl.textContent = '$0.00';
          cartTotalEl.textContent = '$0.00';
          shippingForm.querySelector('button[type="submit"]').disabled = true;
          return;
        }

        let subtotal = 0;
        cart.forEach((item, index) => {
          const itemTotal = item.price * item.quantity;
          subtotal += itemTotal;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td><input type="number" min="1" value="${item.quantity}" data-index="${index}" class="qtyInput"/></td>
            <td>$${itemTotal.toFixed(2)}</td>
            <td><button class="removeBtn" data-index="${index}">Remove</button></td>
          `;
          cartTableBody.appendChild(row);
        });
        
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;

        cartSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        cartTaxEl.textContent = `$${tax.toFixed(2)}`;
        cartTotalEl.textContent = `$${total.toFixed(2)}`;
        
        shippingForm.querySelector('button[type="submit"]').disabled = false;
      }
      
      document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('removeBtn')) {
          let cart = JSON.parse(localStorage.getItem("dripcaseCart")) || [];
          const index = parseInt(e.target.dataset.index);
          if (index > -1) {
            cart.splice(index, 1);
            localStorage.setItem("dripcaseCart", JSON.stringify(cart));
            renderCartSummary();
            updateCartCount();
          }
        }
      });

      document.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('qtyInput')) {
          let cart = JSON.parse(localStorage.getItem("dripcaseCart")) || [];
          const index = parseInt(e.target.dataset.index);
          const value = parseInt(e.target.value);
          
          if (index > -1 && value > 0) {
            cart[index].quantity = value;
            localStorage.setItem("dripcaseCart", JSON.stringify(cart));
            renderCartSummary();
            updateCartCount();
          } else {
            e.target.value = cart[index].quantity;
          }
        }
      });

      shippingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const shippingInfo = {
          fullName: fullNameInput.value,
          address: document.getElementById('address').value,
          trn: trnInput.value,
        };
        generateInvoice(shippingInfo);
      });

      document.getElementById('cancelCheckoutBtn')?.addEventListener('click', () => {
        if (confirm('Are you sure you want to cancel? Your cart will not be saved.')) {
          window.location.href = 'index.html';
        }
      });

      renderCartSummary();
    });
  </script>
</body>
</html>
